<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JS Bin</title>

    <script src="https://code.jquery.com/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.29.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
</head>
<body>

<h2 class="text-center">
    <a href="https://github.com/pyanoveugen/aws_sqs_ui">AWS SQS Console</a>
</h2>

<div class="container" style="padding-top: 10px;">

    <div class="well form-horizontal form-group-sm">
        <div class="form-group">
            <label for="aws_access_key_id" class="control-label col-sm-3">aws_access_key_id</label>
            <div class="col-sm-9">
                <input class="form-control" id="aws_access_key_id">
            </div>
        </div>

        <div class="form-group">
            <label for="aws_secret_access_key" class="control-label col-sm-3">aws_secret_access_key</label>
            <div class="col-sm-9">
                <input class="form-control" id="aws_secret_access_key">
            </div>
        </div>

        <div class="form-group">
            <label for="aws_region" class="control-label col-sm-3">aws_region</label>
            <div class="col-sm-9">
                <select class="form-control" id="aws_region">
                    <option value="us-east-1">US East (N. Virginia)</option>
                    <option value="us-east-2">US East (Ohio)</option>
                    <option value="us-west-1">US West (N. California)</option>
                    <option value="us-west-2">US West (Oregon)</option>
                    <option value="ap-northeast-2">Asia Pacific (Seoul)</option>
                    <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                    <option value="ap-southeast-2">Asia Pacific (Sydney)</option>
                    <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
                    <option value="eu-central-1">EU (Frankfurt)</option>
                    <option value="eu-west-1">EU (Ireland)</option>
                    <option value="eu-west-2">EU (London)</option>
                </select>
            </div>
        </div>

        <hr>

        <button id=get_list class="btn btn-default">get list of queue</button>

        <hr>

        <div class="form-group">
            <label for="sqs_name" class="control-label col-sm-3">sqs name</label>
            <div class="col-sm-9">
                <input class="form-control" id="sqs_name">
            </div>
        </div>

        <div class="form-group">
            <label for="sqs_url" class="control-label col-sm-3">sqs url</label>
            <div class="col-sm-9">
                <input class="form-control" id="sqs_url" disabled value="NONE">
            </div>
        </div>

        <button id=get_url class="btn btn-default">get and set up queue url</button>

        <hr>

        <p>Before start using next commands, you need to initialize sqs url.</p>

        <button id=get_sqs_attr class="btn btn-default">get SQS attributes</button>

        <p></p>

        <div class="row form-group">
            <div class="col-sm-3">
                <button id=get_messages class="btn btn-default">get SQS messages</button>
            </div>
            <div class="checkbox col-sm-3">
                <label for="collect_messages">
                    <input type="checkbox" id="collect_messages"> collect
                </label>
            </div>
            <div class="col-sm-3">
                <label for="sqs_url" class="control-label ">
                    collected <span id="msg_size">...</span>
                </label>
            </div>
            <div class="col-sm-3">
                <button id="btn_msg_clean" class="btn btn-default">clean</button>
            </div>
        </div>

    </div>
</div>


<div id=content class="container">
    result...
</div>

</body>

<script type="text/javascript">
    $(function () {
        function getSQS() {
            localStorage.aws_access_key_id = $("#aws_access_key_id").val();
            localStorage.aws_secret_access_key = $("#aws_secret_access_key").val();
            localStorage.aws_region = $("#aws_region").val();
            localStorage.sqs_name = $("#sqs_name").val();
            localStorage.sqs_url = $("#sqs_url").val() || "NONE";

            var sqs = new AWS.SQS({
                apiVersion: '2012-11-05',
                region: localStorage.aws_region,
                credentials: new AWS.Credentials(
                    localStorage.aws_access_key_id,
                    localStorage.aws_secret_access_key
                )
            });

            return sqs;
        }

        function cleanContent() {
            $("#content").empty();
        }

        function printResult(err, resp) {
            if (err) {
                console.log(err, err.stack); // an error occurred
                $("#content").html($("<pre>").html(JSON.stringify(err, null, 4)));
            } else {
                console.log(resp);           // successful response
                $("#content").html($("<pre>").html(JSON.stringify(resp, null, 4)));
            }
        }

        function setupFormFields() {
            $("#aws_access_key_id").val(localStorage.aws_access_key_id);
            $("#aws_secret_access_key ").val(localStorage.aws_secret_access_key);
            $("#aws_region").val(localStorage.aws_region || "us-west-1");
            $("#sqs_url").val(localStorage.sqs_url);
            $("#sqs_name").val(localStorage.sqs_name);

            $("#btn_msg_clean").trigger("click");
        }

        function updateMessageCount(msg) {
            $("#msg_size").html(msg.length);
        }

        function initBinding() {
            $("#btn_msg_clean").on("click", function () {
                messages = [];
                updateMessageCount(messages);
                cleanContent();
            });

            $("#get_list").on("click", function () {
                cleanContent();

                var sqs = getSQS();
                var params = {};
                sqs.listQueues(params, printResult);
            });

            $("#get_url").on("click", function () {
                cleanContent();

                var sqs = getSQS();
                var params = {
                    QueueName: localStorage.sqs_name
                };

                sqs.getQueueUrl(params, function (err, data) {
                    printResult(err, data);
                    if (!err) {
                        $("#sqs_url").val(localStorage.sqs_url = data.QueueUrl);
                    }
                });
                /**
                 data = {
                QueueUrl: "https://queue.amazonaws.com/123456789101/MyQueue"
            }
                 */
            });

            $("#get_sqs_attr").on("click", function () {
                cleanContent();

                var sqs = getSQS();
                var params = {
                    AttributeNames: [
                        "All"
                    ],
                    QueueUrl: localStorage.sqs_url
                };

                sqs.getQueueAttributes(params, printResult);
                /**
                 data = {
                Attributes: {
                    "ApproximateNumberOfMessages": "0",
                    "ApproximateNumberOfMessagesDelayed": "0",
                    "ApproximateNumberOfMessagesNotVisible": "0",
                    "CreatedTimestamp": "1442426968",
                    "DelaySeconds": "0",
                    "LastModifiedTimestamp": "1442426968",
                    "MaximumMessageSize": "262144",
                    "MessageRetentionPeriod": "345600",
                    "QueueArn": "arn:aws:sqs:us-east-1:80398EXAMPLE:MyNewQueue",
                    "ReceiveMessageWaitTimeSeconds": "0",
                    "RedrivePolicy": "{\"deadLetterTargetArn\":\"arn:aws:sqs:us-east-1:80398EXAMPLE:MyDeadLetterQueue\",\"maxReceiveCount\":1000}",
                    "VisibilityTimeout": "30"
                }
            }
                 */
            });
            $("#get_messages").on("click", function () {
                cleanContent();

                var sqs = getSQS();
                var params = {
                    AttributeNames: [
                        "All"
                    ],
                    MaxNumberOfMessages: 10,
                    MessageAttributeNames: [
                        "All"
                    ],
                    QueueUrl: localStorage.sqs_url,
                    VisibilityTimeout: 1,
                    WaitTimeSeconds: 1
                };

                sqs.receiveMessage(params, function (err, data) {
                    var msg = [];
                    if (!err) {
                        if ($("#collect_messages").prop("checked")) {
                            msg = _.union(messages, data.Messages);
                            msg = _.uniq(msg, function (a) {
                                return a.MessageId;
                            });
                            messages = msg;
                        } else {
                            msg = data.Messages;
                        }
                    }
                    printResult(err, msg);
                    updateMessageCount(msg);
                });
                /**
                 data = {
                Messages: [
                    {
                        Attributes: {
                            "ApproximateFirstReceiveTimestamp": "1442428276921",
                            "ApproximateReceiveCount": "5",
                            "SenderId": "AIDAIAZKMSNQ7TEXAMPLE",
                            "SentTimestamp": "1442428276921"
                        },
                        Body: "My first message.",
                        MD5OfBody: "1000f835...a35411fa",
                        MD5OfMessageAttributes: "9424c491...26bc3ae7",
                        MessageAttributes: {
                            "City": {
                                DataType: "String",
                                StringValue: "Any City"
                            },
                            "PostalCode": {
                                DataType: "String",
                                StringValue: "ABC123"
                            }
                        },
                        MessageId: "d6790f8d-d575-4f01-bc51-40122EXAMPLE",
                        ReceiptHandle: "AQEBzbVv...fqNzFw=="
                    }
                ]
            }
                 */
            });
        }

//        -----

        var messages = [];

        initBinding();
        setupFormFields();
    });
</script>

</html>
